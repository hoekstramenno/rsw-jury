<?php

namespace App\Http\Controllers\Import;

use App\Models\Rating;
use App\Models\Score;
use App\Models\Team;

class ImportController
{
    protected $csv = "1,2,3,4,5,6,7,8a,8b,8c,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30
1,10,15,14,11,8,1,5,8,8,6,17,20,0,0,0,9,0,0,5,71,7,9,2,3,2,3,3,10,6,10,10,-9
2,15,18,15,13,1,0,0,6,7,4,14,7,0,3,0,0,7,0,5,71,7,4,3,4,0,2,2,6,6,10,5,-33
3,15,22,18,14,8,22,0,9,5,3,17,21,10,0,2,8,0,9,13,60,8,3,5,2,0,4,2,8,9,10,10,-38
4,15,20,13,6,3,17,0,8,2,1,10,6,6,4,0,10,0,0,9,60,6,3,6,2,2,6,0,7,7,10,10,-36
5,10,21,9,8,4,15,5,6,4,3,12,19,0,3,5,0,5,0,8,47,8,6,7,7,4,0,3,7,10,10,10,-36
6,15,12,14,12,5,14,1,10,8,5,13,21,4,0,0,7,0,0,6,71,7,3,5,3,2,2,2,8,9,10,10,-11
7,10,20,21,8,10,3,0,5,7,4,15,17,0,8,3,7,0,9,14,47,6,3,6,5,1,3,3,9,9,10,10,-26
8,15,17,14,11,3,5,6,8,8,1,20,15,0,0,0,9,7,8,7,60,7,3,5,2,1,0,0,10,6,10,10,0
9,15,20,7,15,10,18,7,8,8,1,17,19,0,5,0,0,9,0,7,80,7,8,8,2,7,7,1,7,10,10,10,-4
10,15,10,16,6,0,0,0,5,8,2,2,11,8,0,0,5,0,0,4,71,7,7,4,5,1,0,9,3,8,10,10,-4
11,1,18,18,3,0,0,1,6,6,0,10,5,0,5,4,0,0,0,9,47,7,4,1,5,1,3,0,4,7,10,10,-13
12,15,5,16,9,3,0,5,4,6,2,6,5,4,0,0,9,0,7,10,60,8,6,8,1,1,5,1,8,6,10,10,0
13,10,22,16,11,8,25,9,8,7,6,20,20,0,9,0,9,9,9,17,80,8,6,7,7,10,9,10,6,9,10,10,-24
14,10,12,19,12,5,25,1,7,5,5,14,13,9,0,3,7,0,0,13,80,8,3,6,0,1,4,8,9,8,10,10,-35
15,10,20,22,12,9,9,7,9,7,5,17,15,0,0,10,10,9,8,11,47,8,10,10,6,1,0,9,8,7,10,10,-23
16,15,20,17,14,10,22,8,8,5,6,17,22,0,4,1,9,6,0,12,60,5,6,5,4,4,0,3,4,8,10,10,-18
17,15,23,18,12,8,12,7,7,6,7,18,17,6,10,9,10,0,0,12,60,6,5,9,3,7,3,9,7,7,10,10,-2
18,15,19,22,13,10,23,10,7,7,5,17,21,0,0,0,10,8,9,9,71,9,6,10,6,9,8,3,5,9,10,10,-25";

    public function import(int $year)
    {
        $scores = array_map("str_getcsv", explode("\n", $this->csv));

        $ratingNumbers = array_shift($scores);
        $ratingMap = [];
        $teamsMap = [];
        $toImport = [];

        $ratings = Rating::whereHas('year', static function ($query) use ($year) {
            $query->where('label', $year);
        })->where('outside_competition', false)->get();

        $teams = Team::whereHas('year', static function ($query) use ($year) {
            $query->where('label', $year);
        })->get();

        foreach ($ratings as $rating) {
            $ratingMap[$rating->number.$rating->suffix] = $rating->id;
        }

        foreach ($teams as $team) {
            $teamsMap[$team->start_number] = $team->id;
        }

        foreach ($scores as $score) {
            $teamNumber = array_shift($score);

            foreach ($score as $key => $scoreByRating) {
                $toImport[] = [
                    'score' => (int)$scoreByRating,
                    'team_id' => $teamsMap[$teamNumber],
                    'rating_id' => $ratingMap[$ratingNumbers[$key]]
                ];
            }
        }
        dd($toImport);
        foreach ($toImport as $importRow) {
            Score::create($importRow);
        }

    }
}
